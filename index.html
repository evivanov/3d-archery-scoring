<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>3D Archery Score Tracker</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <style>
    body { font-family: sans-serif; margin: auto; padding: 1rem; max-width: 480px; }
    .controls { margin: 1rem 0; display: flex; flex-wrap: wrap; gap: 0.5rem; }
    .actions { display: flex; justify-content: flex-end; gap: 0.5rem; margin: 1rem 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: center; }
    tbody tr:nth-child(even) { background: #f9f9f9; }
    .missed { background: #eee; color: #888; }
    tfoot th { background: #ddd; }
    .hidden { display: none; }
    .slide-enter { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; }
    .slide-enter-active { max-height: 1000px; }
    .preview-row td { padding: 0 !important; border: none; }
    .readonly-table td, .readonly-table th { font-size: 0.9rem; padding: 0.25rem; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script defer src="env.js"></script>
  <script defer src="scores.js"></script>
</head>
<body class="p-4">
  <div class="container">
    <h1 class="title">3D Archery Score Tracker</h1>

    <div class="controls">
      <label class="checkbox"><input type="checkbox" id="remoteToggle"> Use Remote</label>
      <div id="nameContainer" class="hidden">
        <input class="input" type="text" id="archerName" placeholder="Your Name">
        <button class="button is-link" id="loadDataBtn">Load</button>
      </div>
      <button class="button is-info ml-auto" id="exportCSV">Export CSV</button>
    </div>

    <form id="scoreForm">
      <div class="columns is-multiline">
        <div class="column is-one-third">
          <label class="label">Target</label>
          <div class="select is-fullwidth"><select id="targetSelect"></select></div>
        </div>
        <div class="column is-one-third">
          <label class="label">Arrows</label>
          <div class="select is-fullwidth"><select id="arrowsSelect"></select></div>
        </div>
        <div class="column is-one-third">
          <label class="label">Result</label>
          <div class="select is-fullwidth"><select id="resultSelect"></select></div>
        </div>
        <div class="column is-two-thirds">
          <label class="label">Notes</label>
          <input class="input" type="text" id="notesInput">
        </div>
        <div class="column is-one-third">
          <button class="button is-success mt-5" type="button" id="addBtn">Save Target</button>
        </div>
        <div class="column is-one-third">
          <button class="button is-warning mt-5" type="button" id="resetBtn">Reset</button>
        </div>
        <div class="column is-full">
          <label class="checkbox"><input type="checkbox" id="showAllToggle" checked> Show all targets</label>
        </div>
      </div>
    </form>

    <table class="table is-striped score-table">
      <thead>
        <tr><th>Target</th><th>Arrows</th><th>Result</th><th>Score</th><th>Notes</th></tr>
      </thead>
      <tbody id="scoreBody"></tbody>
      <tfoot>
        <tr><th colspan="3">Total</th><th id="totalScore">0</th><th></th></tr>
      </tfoot>
    </table>

    <h2 class="title is-4 mt-6">Leaderboard</h2>
    <div class="controls">
      <button class="button" id="refreshLeaderboard">Refresh</button>
    </div>
    <table class="table" id="leaderboardTable">
      <thead><tr><th>Name</th><th>Date</th><th>Total</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const remoteToggle = document.getElementById('remoteToggle');
    const nameContainer = document.getElementById('nameContainer');
    const archerName = document.getElementById('archerName');
    const loadDataBtn = document.getElementById('loadDataBtn');
    const exportCSV = document.getElementById('exportCSV');
    const targetSelect = document.getElementById('targetSelect');
    const arrowsSelect = document.getElementById('arrowsSelect');
    const resultSelect = document.getElementById('resultSelect');
    const notesInput = document.getElementById('notesInput');
    const addBtn = document.getElementById('addBtn');
    const resetBtn = document.getElementById('resetBtn');
    const showAllToggle = document.getElementById('showAllToggle');
    const scoreBody = document.getElementById('scoreBody');
    const totalScoreEl = document.getElementById('totalScore');
    const refreshLb = document.getElementById('refreshLeaderboard');
    const lbBody = document.querySelector('#leaderboardTable tbody');

    let entries = JSON.parse(localStorage.getItem('entries') || '{}');
    let db, initialized = false;

    function initSelects() {
      targetSelect.innerHTML = '<option value="">Select...</option>';
      for (let i=1; i<=25; i++) targetSelect.add(new Option(i, i));
      arrowsSelect.innerHTML = '<option value="">Select...</option>';
      Object.keys(window.scores.Kill).forEach(k => arrowsSelect.add(new Option(k==='0'?'Miss':k, k)));
      resultSelect.innerHTML = '';
      ['Kill','Wound'].forEach(r => resultSelect.add(new Option(r, r)));
    }

    function saveLocal() {
      localStorage.setItem('entries', JSON.stringify(entries));
      localStorage.setItem('archerName', archerName.value);
      localStorage.setItem('showAll', showAllToggle.checked);
      localStorage.setItem('useRemote', remoteToggle.checked);
    }

    function loadLocal() {
      archerName.value = localStorage.getItem('archerName')||'';
      showAllToggle.checked = localStorage.getItem('showAll')!=='false';
      remoteToggle.checked = localStorage.getItem('useRemote')==='true';
      toggleRemote();
      updateTable();
    }

    function updateTable() {
      scoreBody.innerHTML = '';
      let total = 0;
      const list = showAllToggle.checked
        ? Array.from({length:25},(_,i)=>({target:i+1, ...entries[i+1]}))
        : Object.entries(entries).map(([t,e])=>({target:t, ...e}));
      list.sort((a,b)=>a.target-b.target).forEach(e=>{
        const sc = window.scores[e.resultType]?.[e.arrows] || 0;
        total += sc;
        const tr = document.createElement('tr');
        if (e.arrows==='0') tr.classList.add('missed');
        tr.innerHTML = `<td>${e.target||''}</td>
                        <td>${e.arrows==='0'?'Miss':e.arrows||''}</td>
                        <td>${e.resultType||''}</td>
                        <td>${sc}</td>
                        <td>${e.notes||''}</td>`;
        scoreBody.appendChild(tr);
      });
      totalScoreEl.textContent = total;
    }

    function initFirestore() {
      if (!initialized) {
        firebase.initializeApp(window._env_);
        db = firebase.firestore();
        initialized = true;
      }
      fetchLeaderboard();
    }

    function fetchLeaderboard() {
      lbBody.innerHTML = '';
      if (!db) return;
      db.collection('leaderboard').orderBy('totalScore','desc').limit(10).get()
        .then(snap => snap.docs.forEach(doc => {
          const d = doc.data();
          const tr = document.createElement('tr');
          tr.dataset.name = d.name;
          tr.innerHTML = `<td>${d.name}</td>
                          <td>${new Date(d.date).toLocaleString()}</td>
                          <td>${d.totalScore}</td>`;
          lbBody.appendChild(tr);
        }));
    }

    function toggleRemote() {
      const on = remoteToggle.checked;
      nameContainer.classList.toggle('hidden', !on);
      document.getElementById('leaderboardTable').classList.toggle('hidden', !on);
      saveLocal();
      if (on) initFirestore();
    }

    remoteToggle.addEventListener('change', toggleRemote);
    showAllToggle.addEventListener('change', () => { saveLocal(); updateTable(); });

    loadDataBtn.addEventListener('click', async () => {
      const name = archerName.value.trim();
      if (!name || !initialized) return;
      const doc = await db.collection('leaderboard').doc(name).get();
      if (doc.exists) {
        entries = doc.data().entries || {};
        saveLocal();
        updateTable();
      }
    });

    addBtn.addEventListener('click', () => {
      const t = targetSelect.value;
      const a = arrowsSelect.value==='Miss'?'0':arrowsSelect.value;
      const r = resultSelect.value;
      const n = notesInput.value.trim();
      if (!t||!a||!r) return;
      entries[t] = { arrows: a, resultType: r, notes: n };
      saveLocal();
      updateTable();
      const name = archerName.value.trim();
      if (remoteToggle.checked && initialized && name) {
        const total = Object.values(entries)
          .reduce((s,e)=>s + (window.scores[e.resultType]?.[e.arrows]||0), 0);
        db.collection('leaderboard').doc(name)
          .set({ name, totalScore: total, date: new Date().toISOString(), entries });
      }
    });

    exportCSV.addEventListener('click', () => {
      const hdr = ['Target','Arrows','Result','Score','Notes'];
      const rows = Array.from(scoreBody.rows).map(r=>
        Array.from(r.cells).map(c=>`"${c.textContent}"`)
      );
      const csv = [hdr.map(h=>`"${h}"`),...rows].map(r=>r.join(',')).join('\n');
      const blob = new Blob([csv],{type:'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `scores-${Date.now()}.csv`;
      a.click();
    });

    resetBtn.addEventListener('click', ()=>{
      if (confirm('Reset all entries?')) {
        localStorage.removeItem('entries');
        entries = {};
        updateTable();
      }
    });

    refreshLb.addEventListener('click', fetchLeaderboard);

    document.querySelector('#leaderboardTable tbody')
      .addEventListener('click', async e => {
      const tr = e.target.closest('tr');
      if (!tr||!tr.dataset.name) return;
      const name = tr.dataset.name;
      const doc = await db.collection('leaderboard').doc(name).get();
      if (!doc.exists) return;
      // remove existing preview
      const next = tr.nextSibling;
      if (next && next.classList.contains('preview-row')) { next.remove(); return; }
      // insert preview
      const pr = document.createElement('tr');
      pr.classList.add('preview-row','slide-enter');
      let html = `<td colspan="3"><table class="table readonly-table">
        <thead><tr><th>Target</th><th>Arrows</th><th>Result</th><th>Score</th><th>Notes</th></tr></thead><tbody>`;
      const data = doc.data();
      Object.entries(data.entries||{}).sort((a,b)=>a[0]-b[0]).forEach(([t,e])=>{
        const sc = window.scores[e.resultType]?.[e.arrows]||0;
        html += `<tr><td>${t}</td><td>${e.arrows==='0'?'Miss':e.arrows}</td><td>${e.resultType}</td><td>${sc}</td><td>${e.notes||''}</td></tr>`;
      });
      html += `</tbody><tfoot><tr><th colspan="3">Total</th><th>${data.totalScore}</th><th></th></tr></tfoot></table></td>`;
      pr.innerHTML = html;
      tr.parentNode.insertBefore(pr, next);
      requestAnimationFrame(()=>pr.classList.add('slide-enter-active'));
    });

    initSelects();
    loadLocal();
    updateTable();
  });
  </script>
</body>
</html>
