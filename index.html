<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>3D Archery Scoring</title>
  <style>
    body { font-family: sans-serif; max-width: 480px; margin: auto; padding: 1rem; }
    label { display: block; margin-top: 1rem; }
    select, input[type="text"], input[type="number"] { width: 100%; padding: 0.5rem; margin-top: 0.2rem; }
    button { margin-top: 1rem; padding: 0.5rem 1rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.4rem; text-align: center; }
    tr.missed { background: #eee; color: #888; }
    /* Grey out the score cell when missed */
    tr.missed td:nth-child(3) { color: #aaa; }
    .controls { margin-top: 1rem; }
    .hidden { display: none; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
  <script src="env.js"></script>
  <script src="scores.js"></script>
</head>
<body>
  <h1>3D Archery Scoring</h1>

  <div class="controls">
    <label><input type="checkbox" id="useRemote" /> Use Remote</label>
  </div>

  <label id="labelName" class="hidden">Name<input type="text" id="archerName" placeholder="Your name" /></label>

  <label>Target<select id="target"></select></label>
  <label>Arrows Hit<select id="arrows"></select></label>
  <label>Notes<input type="text" id="notes" /></label>
  <button id="addBtn">Add / Update</button>
  <button id="resetBtn">Reset</button>

  <table id="scoreTable">
    <thead><tr><th>Target</th><th>Arrows</th><th>Score</th><th>Notes</th></tr></thead>
    <tbody></tbody>
  </table>

  <div id="leaderboardContainer" class="hidden">
    <h2>Leaderboard</h2>
    <button id="refreshLeaderboard">Refresh</button>
    <table id="leaderboard">
      <thead><tr><th>Name</th><th>Score</th><th>Date</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    // Load scores mapping from scores.js
    const mapping = window.scores;
    const entries = JSON.parse(localStorage.getItem('entries')||'{}');

    // DOM refs
    const useRemote = document.getElementById('useRemote');
    const labelName = document.getElementById('labelName');
    const archerName = document.getElementById('archerName');
    const targetSel = document.getElementById('target');
    const arrowsSel = document.getElementById('arrows');
    const notesInput = document.getElementById('notes');
    const addBtn = document.getElementById('addBtn');
    const resetBtn = document.getElementById('resetBtn');
    const scoreTbody = document.querySelector('#scoreTable tbody');
    const lbContainer = document.getElementById('leaderboardContainer');
    const refreshLb = document.getElementById('refreshLeaderboard');
    const lbTbody = document.querySelector('#leaderboard tbody');

    // Populate selects
    function initSelects() {
      targetSel.innerHTML = '<option value="">Select...</option>';
      for (let i=1;i<=25;i++) targetSel.add(new Option(i, i));
      arrowsSel.innerHTML = '<option value="">Select...</option>';
      Object.keys(mapping).forEach(k => arrowsSel.add(new Option(k==='0'?'Miss':k, k)));
    }

    function saveLocal() {
      localStorage.setItem('entries', JSON.stringify(entries));
      localStorage.setItem('archerName', archerName.value);
      localStorage.setItem('useRemote', useRemote.checked);
    }

    function loadLocal() {
      archerName.value = localStorage.getItem('archerName')||'';
      const ur = localStorage.getItem('useRemote')==='true';
      useRemote.checked = ur;
      toggleRemote(ur);
    }

    function updateTable() {
      scoreTbody.innerHTML='';
      Object.entries(entries).sort((a,b)=>a[0]-b[0]).forEach(([t,e])=>{
        const sc = e.arrows==='0'?0:(mapping[e.arrows]||0);
        const tr = document.createElement('tr');
        if (e.arrows==='0') tr.classList.add('missed');
        tr.innerHTML=`<td>${t}</td><td>${e.arrows==='0'?'Miss':e.arrows}</td><td>${sc}</td><td>${e.notes||''}</td>`;
        scoreTbody.appendChild(tr);
      });
    }

    function toggleRemote(on) {
      labelName.classList.toggle('hidden',!on);
      lbContainer.classList.toggle('hidden',!on);
      saveLocal();
      if (on) initFirestore();
    }

    // Firebase
    let db, inited=false;
    function initFirestore() {
      if (!inited && window._env_) {
        firebase.initializeApp(window._env_);
        db = firebase.firestore();
        inited=true;
      }
      fetchLb();
    }
    function fetchLb() {
      if (!db) return;
      lbTbody.innerHTML='';
      db.collection('leaderboard').orderBy('totalScore','desc').limit(10).get()
        .then(snap=>snap.docs.forEach(d=>{
          const rd=d.data();
          lbTbody.insertAdjacentHTML('beforeend',`<tr><td>${rd.name}</td><td>${rd.totalScore}</td><td>${new Date(rd.date).toLocaleString()}</td></tr>`);
        }));
    }

    // Events
    useRemote.addEventListener('change',()=>toggleRemote(useRemote.checked));
    addBtn.addEventListener('click',()=>{
      const t=targetSel.value, a=arrowsSel.value;
      if(!t||!a) return;
      entries[t]={arrows:a,notes:notesInput.value};
      saveLocal(); updateTable();
      if(useRemote.checked&&inited){
        const total=Object.values(entries).reduce((s,e)=>s+ +mapping[e.arrows],0);
        db.collection('leaderboard').doc(archerName.value).set({name:archerName.value,totalScore:total,date:new Date().toISOString()});
      }
    });
    resetBtn.addEventListener('click',()=>{localStorage.removeItem('entries'); for(let k in entries) delete entries[k]; updateTable();});
    refreshLb.addEventListener('click',fetchLb);

    // Init
    initSelects(); loadLocal(); updateTable();
  </script>
</body>
</html>
