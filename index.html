<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>3D Archery Score Tracker</title>
  <!-- Bulma CSS Framework for modern UI components -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <style>
    /* Global Body Styling */
    body {
      font-family: 'Inter', sans-serif; /* Using Inter for a clean, modern font */
      margin: auto; /* Center the content */
      padding: 1.5rem; /* Add padding around the entire page */
      max-width: 600px; /* Max width for better readability on large screens */
      background-color: #f0f2f5; /* Light background color */
      color: #333; /* Default text color */
      line-height: 1.6;
    }

    /* General Container Styling */
    .container {
      background-color: #ffffff; /* White background for the main content area */
      padding: 2rem;
      border-radius: 12px; /* Rounded corners for the main container */
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08); /* Soft shadow for depth */
    }

    /* Title Styling */
    .title {
      color: #2c3e50; /* Darker title color */
      text-align: center;
      margin-bottom: 1.5rem;
      font-weight: 700;
      font-size: 2.2rem;
    }

    /* Control Section Styling */
    .controls {
      margin: 1.5rem 0;
      display: flex;
      flex-wrap: wrap; /* Allow items to wrap on smaller screens */
      gap: 0.75rem; /* Space between control elements */
      align-items: center; /* Vertically center items in this flex container */
      padding-bottom: 1rem;
      border-bottom: 1px solid #eee; /* Separator line */
    }

    /* Actions Section Styling (for buttons like export) */
    .actions {
      display: flex;
      justify-content: flex-end; /* Align action buttons to the right */
      gap: 0.75rem;
      margin: 1rem 0;
    }

    /* Table Styling */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1.5rem;
      border-radius: 8px; /* Rounded corners for tables */
      overflow: hidden; /* Ensures rounded corners apply to content */
    }

    th, td {
      border: 1px solid #e0e0e0; /* Lighter borders for cells */
      padding: 0.75rem;
      text-align: center;
      font-size: 0.95rem;
    }

    thead th {
      background-color: #f5f7fa; /* Light header background */
      color: #555;
      font-weight: 600;
    }

    tbody tr:nth-child(even) {
      background: #fdfdfd; /* Very light alternating row color */
    }
    tbody tr:hover {
      background-color: #e6f7ff; /* Light blue on hover for clickable rows */
      cursor: pointer;
    }

    /* Styling for missed entries */
    .missed {
      background: #f8f8f8; /* Slightly greyed out background */
      color: #888;
      font-style: italic;
    }

    /* Grey out the score cell when missed */
    .missed td:nth-child(4) { /* Assuming Score is the 4th column */
      color: #aaa;
    }

    /* Footer row for total score */
    tfoot th {
      background: #e9ecef; /* Darker background for footer */
      color: #333;
      font-weight: 700;
    }

    /* Utility class to hide elements */
    .hidden {
      display: none !important; /* Use !important to override Bulma's display properties */
    }

    /* Animation for preview row */
    .slide-enter {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease-out;
    }
    .slide-enter-active {
      max-height: 1000px; /* Sufficiently large value for animation */
    }

    /* Styling for the preview row within the leaderboard */
    .preview-row td {
      padding: 0 !important; /* Remove padding for nested table */
      border: none; /* Remove border for the outer cell */
    }

    /* Styling for the nested table within the preview row */
    .readonly-table {
      margin: 0; /* Remove margin */
      box-shadow: none; /* Remove shadow */
      border-radius: 0; /* Remove border radius */
      width: 100%; /* Ensure it takes full width */
    }
    .readonly-table td, .readonly-table th {
      font-size: 0.85rem; /* Smaller font for nested table */
      padding: 0.4rem; /* Smaller padding */
      border: 1px solid #f0f0f0; /* Lighter border */
    }
    .readonly-table thead th {
      background-color: #eef1f4; /* Slightly different header for nested table */
    }
    .readonly-table tfoot th {
      background-color: #e0e4e8; /* Slightly different footer for nested table */
    }

    /* Custom Modal Styling */
    .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1000; /* Sit on top */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        background-color: #fefefe;
        margin: auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%; /* Could be more responsive */
        max-width: 400px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        text-align: center;
    }

    .modal-buttons {
        margin-top: 20px;
        display: flex;
        justify-content: space-around;
        gap: 10px;
    }

    .modal-buttons .button {
        flex-grow: 1; /* Make buttons take equal width */
    }

    /* Styling for disabled select/input when arrows is 'Miss' or 'Custom' */
    .select.is-disabled select,
    .input.is-disabled { /* Apply to input directly */
      background-color: #e9ecef; /* Light grey background */
      cursor: not-allowed;
      opacity: 0.7;
    }

    /* Alignment adjustments for buttons within controls */
    .controls .button {
        margin-top: 0; /* Remove default margin-top from Bulma's .button */
    }
    .controls .field {
        margin-bottom: 0; /* Remove default margin-bottom from Bulma's .field */
    }

    /* Alignment adjustments for form buttons */
    .column .button {
        /* Adjusted margin-top to align with the notes input field */
        margin-top: 2.2rem !important; /* This value is tuned for visual alignment */
    }

    /* Hide Notes column on mobile */
    @media (max-width: 768px) { /* Bulma's tablet breakpoint */
      .hide-on-mobile {
        display: none;
      }
    }
  </style>
  <!-- Firebase SDKs - using compat versions as in your original code -->
  <!-- Note: These are external. If you want a truly single file, their content would need to be inlined. -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <!-- Your custom environment and scores data -->
  <!-- Note: These are external. If you want a truly single file, their content would need to be inlined. -->
  <script src="env.js"></script>
  <script src="scores.js"></script>
</head>
<body class="p-4">
  <div class="container">
    <h1 class="title is-2">3D Archery Score Tracker</h1>

    <!-- Controls Section: Remote Toggle, Name Input, Export CSV -->
    <div class="controls">
      <label class="checkbox">
        <input type="checkbox" id="remoteToggle"> Use Remote Leaderboard
      </label>
      <div id="nameContainer" class="field has-addons is-flex-grow-1 ml-4 hidden">
        <div class="control">
          <label class="label is-inline-block mr-2 mt-2">Name:</label> <!-- Added label for name input -->
        </div>
        <div class="control is-expanded">
          <input class="input is-rounded" type="text" id="archerName" placeholder="Your Name">
        </div>
        <div class="control">
          <button class="button is-link is-rounded" id="loadDataBtn">Load</button>
        </div>
      </div>
      <button class="button is-info is-rounded ml-auto" id="exportCSV">Export CSV</button>
    </div>

    <!-- Score Entry Form -->
    <form id="scoreForm">
      <div class="columns is-multiline">
        <!-- Target Select -->
        <div class="column is-one-third">
          <label class="label">Target</label>
          <div class="select is-fullwidth is-rounded">
            <select id="targetSelect"></select>
          </div>
        </div>
        <!-- Arrows Select -->
        <div class="column is-one-third">
          <label class="label">Arrows</label>
          <div class="select is-fullwidth is-rounded">
            <select id="arrowsSelect"></select>
          </div>
        </div>
        <!-- Result Select (Kill/Wound) OR Custom Score Input -->
        <div class="column is-one-third">
          <label class="label">Result</label>
          <div class="select is-fullwidth is-rounded" id="resultSelectWrapper">
            <select id="resultSelect"></select>
          </div>
          <div class="control is-fullwidth hidden" id="customScoreInputWrapper">
            <input class="input is-rounded" type="number" id="customScoreInput" placeholder="Enter Score" min="0" step="1">
          </div>
        </div>
        <!-- Notes Input -->
        <div class="column is-two-thirds">
          <label class="label">Notes</label>
          <input class="input is-rounded" type="text" id="notesInput" placeholder="Add notes (optional, visible on desktop)">
        </div>
        <!-- Save Target Button -->
        <div class="column is-one-third">
          <button class="button is-success is-rounded is-fullwidth" type="button" id="addBtn">Save Target</button>
        </div>
        <!-- Reset Button -->
        <div class="column is-one-third">
          <button class="button is-warning is-rounded is-fullwidth" type="button" id="resetBtn">Reset All</button>
        </div>
        <!-- Show All Targets Toggle -->
        <div class="column is-full">
          <label class="checkbox mt-4">
            <input type="checkbox" id="showAllToggle" checked> Show all targets (even un-scored)
          </label>
        </div>
      </div>
    </form>

    <!-- Local Score Table -->
    <table class="table is-striped is-hoverable is-fullwidth score-table">
      <thead>
        <tr>
          <th>#</th> <!-- Changed label to # -->
          <th>Arrows</th>
          <th>Result</th>
          <th>Score</th>
          <th class="hide-on-mobile">Notes</th> <!-- Hidden on mobile -->
        </tr>
      </thead>
      <tbody id="scoreBody">
        <!-- Score entries will be dynamically inserted here -->
      </tbody>
      <tfoot>
        <tr>
          <th colspan="3">Total Score</th> <!-- Fixed colspan to span #, Arrows, Result -->
          <th id="totalScore">0</th>
          <th class="hide-on-mobile"></th> <!-- Empty th for Notes column alignment -->
        </tr>
      </tfoot>
    </table>

    <!-- Leaderboard Section -->
    <div id="leaderboardSection" class="hidden"> <!-- Added wrapper div for the whole section -->
      <h2 class="title is-4 mt-6">Global Leaderboard</h2>
      <div class="controls">
        <div class="select is-rounded">
          <select id="monthSelect"></select>
        </div>
        <button class="button is-primary is-rounded ml-auto" id="refreshLeaderboard">Refresh Leaderboard</button>
      </div>
      <table class="table is-striped is-hoverable is-fullwidth" id="leaderboardTable">
        <thead><tr><th>Name</th><th>Date</th><th>Total Score</th></tr></thead>
        <tbody>
          <!-- Leaderboard entries will be dynamically inserted here -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Custom Confirmation Modal -->
  <div id="confirmationModal" class="modal">
    <div class="modal-content">
      <p>Are you sure you want to reset all local scores?</p>
      <div class="modal-buttons">
        <button class="button is-danger" id="confirmResetYes">Yes, Reset</button>
        <button class="button is-light" id="confirmResetNo">No, Cancel</button>
      </div>
    </div>
  </div>

  <script>
  // Ensure the DOM is fully loaded before running JavaScript
  document.addEventListener('DOMContentLoaded', () => {
    // --- DOM Element References ---
    const remoteToggle = document.getElementById('remoteToggle');
    const nameContainer = document.getElementById('nameContainer');
    const archerName = document.getElementById('archerName');
    const loadDataBtn = document.getElementById('loadDataBtn');
    const exportCSV = document.getElementById('exportCSV');
    const targetSelect = document.getElementById('targetSelect');
    const arrowsSelect = document.getElementById('arrowsSelect');
    const resultSelect = document.getElementById('resultSelect');
    const resultSelectWrapper = document.getElementById('resultSelectWrapper'); // Wrapper for disabling
    const customScoreInput = document.getElementById('customScoreInput'); // New custom score input
    const customScoreInputWrapper = document.getElementById('customScoreInputWrapper'); // New custom score input wrapper
    const notesInput = document.getElementById('notesInput');
    const addBtn = document.getElementById('addBtn');
    const resetBtn = document.getElementById('resetBtn');
    const showAllToggle = document.getElementById('showAllToggle');
    const totalTargetsDisplay = document.getElementById('totalTargetsDisplay'); // Element to display total targets
    const scoreBody = document.getElementById('scoreBody');
    const totalScoreEl = document.getElementById('totalScore');
    // const totalScoreLabel = document.getElementById('totalScoreLabel'); // Removed as colspan is fixed in HTML
    const leaderboardSection = document.getElementById('leaderboardSection'); // Reference for the whole leaderboard section
    const monthSelect = document.getElementById('monthSelect'); // New month select dropdown
    const refreshLb = document.getElementById('refreshLeaderboard');
    const lbBody = document.querySelector('#leaderboardTable tbody');
    const scoreForm = document.getElementById('scoreForm'); // Reference to the score form for scrolling

    // Modal elements
    const confirmationModal = document.getElementById('confirmationModal');
    const confirmResetYes = document.getElementById('confirmResetYes');
    const confirmResetNo = document.getElementById('confirmResetNo');

    // --- Application State Variables ---
    // Load entries from local storage or initialize as an empty object
    let entries = JSON.parse(localStorage.getItem('entries') || '{}');
    let db; // Firestore database instance
    let firestoreInitialized = false; // Flag to track Firestore initialization
    let allLeaderboardData = []; // Store all fetched leaderboard data for client-side filtering

    // --- Constants for numerical codes ---
    const MISS_ARROW_STR = '0'; // String representation for 'Miss' in dropdown
    const CUSTOM_ARROW_STR = 'custom'; // String representation for 'Custom' in dropdown
    const KILL_CODE = 1;
    const WOUND_CODE = 2;
    const NO_RESULT_CODE = 0; // For Miss or Custom scores

    // Reverse mapping for displaying result types
    const RESULT_CODES_MAP = {
      [KILL_CODE]: 'Kill',
      [WOUND_CODE]: 'Wound',
      [NO_RESULT_CODE]: '' // For Miss or Custom, no specific result type
    };

    // Get total targets from scores.js, default to 25 if not defined
    const TOTAL_TARGETS = window.scores?.TOTAL_TARGETS || 25;
    totalTargetsDisplay.textContent = TOTAL_TARGETS; // Update display in HTML

    // --- Utility Functions ---

    /**
     * Capitalizes the first letter of a string and trims whitespace.
     * @param {string} str - The input string.
     * @returns {string} The formatted string.
     */
    function formatName(str) {
      if (!str) return '';
      str = str.trim();
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    /**
     * Checks if the screen width is considered mobile.
     * Corresponds to Bulma's `max-width: 768px` for mobile.
     * @returns {boolean} True if mobile, false otherwise.
     */
    function isMobile() {
      return window.innerWidth <= 768;
    }

    /**
     * Populates the 'Target', 'Arrows', and 'Result' select dropdowns.
     */
    function initSelects() {
      // Populate Target dropdown (1 to TOTAL_TARGETS)
      targetSelect.innerHTML = '<option value="">Select Target...</option>';
      for (let i = 1; i <= TOTAL_TARGETS; i++) {
        targetSelect.add(new Option(i, i));
      }

      // Populate Arrows dropdown
      arrowsSelect.innerHTML = '<option value="">Select Arrows...</option>';
      if (window.scores && (window.scores[KILL_CODE] || window.scores[WOUND_CODE])) {
        const arrowValues = new Set();
        // Iterate through the numerical keys of Kill and Wound scores to get all arrow values
        if (window.scores[KILL_CODE]) {
          Object.keys(window.scores[KILL_CODE]).forEach(k => arrowValues.add(parseInt(k)));
        }
        if (window.scores[WOUND_CODE]) {
          Object.keys(window.scores[WOUND_CODE]).forEach(k => arrowValues.add(parseInt(k)));
        }
        
        // Add standard arrow options, sorted in ascending order (1, 2, 3)
        Array.from(arrowValues).sort((a,b) => a-b).forEach(val => { // Changed sort order to a-b
            if (val !== 0) { // '0' is handled as 'Miss' explicitly
                arrowsSelect.add(new Option(val.toString(), val.toString()));
            }
        });
        arrowsSelect.add(new Option('Miss', MISS_ARROW_STR)); // Add Miss explicitly
      } else {
        console.error("window.scores is not defined or missing numerical keys. Check scores.js.");
        // Fallback options if scores.js isn't loaded correctly or malformed
        arrowsSelect.add(new Option('1', '1')); // Changed fallback to 1, 2, 3
        arrowsSelect.add(new Option('2', '2'));
        arrowsSelect.add(new Option('3', '3'));
        arrowsSelect.add(new Option('Miss', MISS_ARROW_STR));
      }
      arrowsSelect.add(new Option('Custom', CUSTOM_ARROW_STR)); // Add Custom option


      // Populate Result dropdown (Kill, Wound)
      resultSelect.innerHTML = '<option value="">Select Result...</option>';
      resultSelect.add(new Option(RESULT_CODES_MAP[KILL_CODE], KILL_CODE));
      resultSelect.add(new Option(RESULT_CODES_MAP[WOUND_CODE], WOUND_CODE));
    }

    /**
     * Saves the current state of 'entries', 'archerName', 'showAll', and 'useRemote' to local storage.
     */
    function saveLocal() {
      localStorage.setItem('entries', JSON.stringify(entries));
      localStorage.setItem('archerName', archerName.value);
      localStorage.setItem('showAll', showAllToggle.checked);
      localStorage.setItem('useRemote', remoteToggle.checked);
    }

    /**
     * Loads saved preferences from local storage and applies them to the UI.
     */
    function loadLocal() {
      archerName.value = localStorage.getItem('archerName') || '';
      // Convert string 'false' back to boolean false, otherwise true
      showAllToggle.checked = localStorage.getItem('showAll') !== 'false';
      remoteToggle.checked = localStorage.getItem('useRemote') === 'true';
      toggleRemote(); // Apply the remote toggle state based on loaded value
      updateTable(); // Update the score table based on loaded entries
    }

    /**
     * Updates the local score table based on the 'entries' object and 'showAllToggle' state.
     */
    function updateTable() {
      scoreBody.innerHTML = ''; // Clear existing table rows
      let total = 0;

      // Determine which entries to display based on 'showAllToggle'
      const listToDisplay = showAllToggle.checked
        ? Array.from({ length: TOTAL_TARGETS }, (_, i) => ({ target: i + 1, ...entries[i + 1] })) // All TOTAL_TARGETS targets
        : Object.entries(entries).map(([t, e]) => ({ target: parseInt(t), ...e })); // Only scored targets

      // Sort entries numerically by target ID
      listToDisplay.sort((a, b) => a.target - b.target).forEach(entry => {
        let displayArrows = '';
        let displayResult = '';
        let score = 0;

        // Determine display values and score based on stored numerical values
        if (entry.arrows === 0) { // Miss (numerical 0)
            displayArrows = 'Miss';
            displayResult = '';
            score = 0;
        } else if (typeof entry.arrows === 'number' && entry.resultType === NO_RESULT_CODE && entry.arrows !== 0) {
            // This is a custom score (numerical arrows, resultType 0, arrows not 0)
            displayArrows = 'Custom'; // Display 'Custom' in Arrows column
            displayResult = ''; // No result type for custom
            score = entry.arrows; // Custom score is the arrow value itself
        } else if (typeof entry.arrows === 'number' && typeof entry.resultType === 'number') {
            // Standard Kill/Wound scores (numerical arrows and resultType)
            displayArrows = entry.arrows.toString();
            displayResult = RESULT_CODES_MAP[entry.resultType] || '';
            score = window.scores?.[entry.resultType]?.[entry.arrows] || 0;
        } else { // Fallback for undefined or malformed entries (e.g., old string data)
            displayArrows = entry.arrows || '';
            displayResult = entry.resultType || '';
            score = 0; // Default score
            console.warn("Unexpected entry format encountered:", entry);
        }

        total += score; // Accumulate total score

        const tr = document.createElement('tr'); // Create a new table row
        if (entry.arrows === 0) { // Check for numerical 0 for Miss
          tr.classList.add('missed'); // Add 'missed' class if arrows hit is '0'
        }

        // Populate the row with data. Use empty string if data is undefined for display.
        tr.innerHTML = `
          <td>${entry.target || ''}</td>
          <td>${displayArrows}</td>
          <td>${displayResult}</td>
          <td>${score}</td>
          <td class="hide-on-mobile">${entry.notes || ''}</td> <!-- Hidden on mobile -->
        `;
        scoreBody.appendChild(tr); // Append the row to the table body
      });

      totalScoreEl.textContent = total; // Update the displayed total score
    }

    /**
     * Initializes Firebase Firestore if it hasn't been initialized yet and
     * the Firebase environment configuration (window._env_) is available.
     */
    function initFirestore() {
      if (!firestoreInitialized) {
        if (window._env_) {
          try {
            firebase.initializeApp(window._env_); // Initialize Firebase app
            db = firebase.firestore(); // Get Firestore instance
            firestoreInitialized = true; // Set flag to true
            console.log("Firebase Firestore initialized successfully.");
          } catch (error) {
            console.error("Error initializing Firebase Firestore:", error);
            // In a real app, you might show a more user-friendly error message here
          }
        } else {
          console.warn("Firebase environment configuration (window._env_) not found. Firestore cannot be initialized.");
        }
      }
      // Always attempt to fetch leaderboard after init (or if already inited)
      if (firestoreInitialized) {
        fetchAllLeaderboardData(); // Fetch all data first
      }
    }

    /**
     * Fetches ALL leaderboard data from Firestore and stores it.
     * Then initializes the month select and displays the default leaderboard.
     */
    async function fetchAllLeaderboardData() {
      lbBody.innerHTML = '<tr><td colspan="3">Loading leaderboard...</td></tr>'; // Loading indicator
      if (!db) {
        lbBody.innerHTML = '<tr><td colspan="3">Firestore not initialized.</td></tr>';
        console.warn("Firestore not initialized. Cannot fetch leaderboard.");
        return;
      }

      try {
        const snapshot = await db.collection('leaderboard')
          .orderBy('date', 'desc') // Order by date to easily get unique months
          .get();

        allLeaderboardData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        initLeaderboardMonthSelect(); // Populate month dropdown based on fetched data
        
        // Set default filter to current month
        const today = new Date();
        const currentMonthValue = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;
        monthSelect.value = currentMonthValue; // Set the dropdown to current month
        displayLeaderboard(currentMonthValue); // Display current month by default

      } catch (error) {
        console.error("Error fetching all leaderboard data:", error);
        lbBody.innerHTML = `<tr><td colspan="3">Error loading leaderboard.</td>`;
        allLeaderboardData = []; // Clear data on error
      }
    }

    /**
     * Populates the month selection dropdown based on available data dates.
     */
    function initLeaderboardMonthSelect() {
        monthSelect.innerHTML = ''; // Clear existing options

        // Add default options
        monthSelect.add(new Option('Total Leaderboard', 'total'));
        
        const today = new Date();
        const currentMonthValue = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;
        monthSelect.add(new Option('Current Month', currentMonthValue));

        const uniqueMonths = new Set();
        allLeaderboardData.forEach(data => {
            if (data.date) {
                const entryDate = new Date(data.date);
                const monthYear = `${entryDate.getFullYear()}-${(entryDate.getMonth() + 1).toString().padStart(2, '0')}`;
                uniqueMonths.add(monthYear);
            }
        });

        // Add past months, sorted
        Array.from(uniqueMonths)
            .sort((a, b) => b.localeCompare(a)) // Sort in descending order (newest first)
            .forEach(monthYear => {
                if (monthYear !== currentMonthValue) { // Avoid duplicating 'Current Month'
                    const [year, month] = monthYear.split('-');
                    const monthName = new Date(year, parseInt(month) - 1, 1).toLocaleString('en-US', { month: 'long' });
                    monthSelect.add(new Option(`${monthName} ${year}`, monthYear));
                }
            });
    }


    /**
     * Displays the leaderboard data, filtered by the given month.
     * @param {string} filter - 'total' for all data, or 'YYYY-MM' for a specific month.
     */
    function displayLeaderboard(filter) {
        lbBody.innerHTML = ''; // Clear existing entries
        let filteredData = [];

        // Remove any existing preview row
        const existingPreview = document.querySelector('.preview-row');
        if (existingPreview) {
            existingPreview.remove();
        }

        if (filter === 'total') {
            filteredData = allLeaderboardData;
        } else {
            // Filter by month (YYYY-MM)
            filteredData = allLeaderboardData.filter(data => {
                if (data.date) {
                    const entryDate = new Date(data.date);
                    const monthYear = `${entryDate.getFullYear()}-${(entryDate.getMonth() + 1).toString().padStart(2, '0')}`;
                    return monthYear === filter;
                }
                return false;
            });
        }

        if (filteredData.length === 0) {
            lbBody.insertAdjacentHTML('beforeend', `<tr><td colspan="3">No leaderboard data for this period.</td></tr>`);
            return;
        }

        // Sort filtered data by totalScore descending
        filteredData.sort((a, b) => b.totalScore - a.totalScore).forEach(data => {
            const dateObj = new Date(data.date);
            // Format date to DD-MM-YYYY
            const formattedDate = dateObj.toLocaleDateString('nl-NL', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            // Format time to HH:MM (24-hour)
            const formattedTime = dateObj.toLocaleTimeString('nl-NL', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });

            const tr = document.createElement('tr');
            tr.dataset.name = data.name; // Store name in dataset for click event
            tr.innerHTML = `
                <td>${data.name}</td>
                <td>${formattedDate}, ${formattedTime}</td>
                <td>${data.totalScore}</td>
            `;
            lbBody.appendChild(tr);
        });
    }


    /**
     * Toggles the visibility of remote-related UI elements (name input, leaderboard section).
     * This function is called when the remoteToggle checkbox changes.
     */
    function toggleRemote() {
      const on = remoteToggle.checked;
      nameContainer.classList.toggle('hidden', !on); // Show/hide name input container
      leaderboardSection.classList.toggle('hidden', !on); // Show/hide the entire leaderboard section
      saveLocal(); // Save the current state of the 'useRemote' checkbox

      if (on) {
        initFirestore(); // Initialize Firestore if remote is enabled
      }
    }

    // --- Custom Confirmation Modal Logic ---
    /**
     * Shows the custom confirmation modal.
     */
    function showConfirmationModal() {
        confirmationModal.style.display = 'flex'; // Use flex to center content
    }

    /**
     * Hides the custom confirmation modal.
     */
    function hideConfirmationModal() {
        confirmationModal.style.display = 'none';
    }

    // --- Event Listeners ---

    // Listen for changes on the 'remoteToggle' checkbox
    remoteToggle.addEventListener('change', toggleRemote);

    // Listen for changes on the 'showAllToggle' checkbox
    showAllToggle.addEventListener('change', () => {
      saveLocal(); // Save the state
      updateTable(); // Refresh table display
    });

    // Listen for changes on the 'targetSelect' to pre-fill form
    targetSelect.addEventListener('change', () => {
        const selectedTarget = targetSelect.value;
        if (selectedTarget && entries[selectedTarget]) {
            // If data exists for the selected target, pre-fill the form fields
            const entry = entries[selectedTarget];

            // Handle arrows pre-fill, including 'Custom'
            if (typeof entry.arrows === 'number' && entry.resultType === NO_RESULT_CODE && entry.arrows !== 0) {
                // This is a custom score (stored as a number, resultType 0, and not 0 itself)
                arrowsSelect.value = CUSTOM_ARROW_STR;
                customScoreInput.value = entry.arrows;
            } else if (entry.arrows === 0) { // Miss (numerical 0)
                arrowsSelect.value = MISS_ARROW_STR;
            } else {
                arrowsSelect.value = entry.arrows.toString(); // Standard numerical arrows (1, 2, 3)
            }

            resultSelect.value = entry.resultType; // This will be the numerical code (1, 2, or 0)
            notesInput.value = entry.notes;

            // Update visibility and disabled state based on pre-filled arrows
            handleArrowsSelectChange(); // Call the handler directly
        } else {
            // If no data or no target selected, clear the form fields
            arrowsSelect.value = '';
            resultSelect.value = '';
            notesInput.value = '';
            customScoreInput.value = ''; // Clear custom score input
            // Ensure resultSelect is enabled and custom input is hidden
            resultSelect.disabled = false;
            resultSelectWrapper.classList.remove('is-disabled');
            customScoreInputWrapper.classList.add('hidden');
        }
    });

    /**
     * Handles changes to the 'arrowsSelect' dropdown, controlling visibility and
     * disabled state of 'resultSelect' and 'customScoreInput'.
     */
    function handleArrowsSelectChange() {
        const selectedArrow = arrowsSelect.value;

        if (selectedArrow === CUSTOM_ARROW_STR) {
            resultSelectWrapper.classList.add('hidden'); // Hide standard result dropdown
            customScoreInputWrapper.classList.remove('hidden'); // Show custom score input
            customScoreInput.disabled = false; // Ensure custom input is enabled
            resultSelect.value = ''; // Clear result selection
        } else if (selectedArrow === MISS_ARROW_STR) {
            resultSelectWrapper.classList.remove('hidden'); // Show standard result dropdown
            customScoreInputWrapper.classList.add('hidden'); // Hide custom score input
            resultSelect.value = ''; // Clear result selection
            resultSelect.disabled = true; // Disable result dropdown
            resultSelectWrapper.classList.add('is-disabled'); // Add Bulma's disabled class for styling
        } else {
            resultSelectWrapper.classList.remove('hidden'); // Show standard result dropdown
            customScoreInputWrapper.classList.add('hidden'); // Hide custom score input
            resultSelect.disabled = false; // Enable result dropdown
            resultSelectWrapper.classList.remove('is-disabled'); // Remove Bulma's disabled class
        }
    }
    arrowsSelect.addEventListener('change', handleArrowsSelectChange);


    // Listen for clicks on the 'Load Data' button (for remote data)
    loadDataBtn.addEventListener('click', async () => {
      let name = archerName.value;
      if (!name) {
        alert('Please enter your name to load data.'); // Basic validation
        return;
      }
      name = formatName(name); // Format the name
      archerName.value = name; // Update the input field with formatted name

      if (!firestoreInitialized) {
        alert('Firebase is not initialized. Cannot load remote data.');
        return;
      }

      try {
        const doc = await db.collection('leaderboard').doc(name).get();
        if (doc.exists) {
          entries = doc.data().entries || {}; // Load specific archer's entries
          saveLocal(); // Save loaded entries to local storage
          updateTable(); // Refresh local score table
          alert(`Data for ${name} loaded successfully!`);
        } else {
          alert(`No data found for ${name}.`);
        }
      }
      catch (error) {
        console.error("Error loading remote data:", error);
        alert("Failed to load remote data. Check console for details.");
      }
    });

    // Listen for clicks on the 'Save Target' button
    addBtn.addEventListener('click', () => {
      const target = targetSelect.value;
      const selectedArrowOption = arrowsSelect.value;
      let arrowsValue; // This will hold the numerical arrows value to be stored
      let resultTypeValue; // This will hold the numerical result type value to be stored

      // Determine arrowsValue and resultTypeValue based on selected option
      if (selectedArrowOption === CUSTOM_ARROW_STR) {
          arrowsValue = parseInt(customScoreInput.value);
          if (isNaN(arrowsValue) || arrowsValue < 0) {
              alert('Please enter a valid non-negative integer for Custom Score.');
              return;
          }
          resultTypeValue = NO_RESULT_CODE; // Custom score has no standard result type
      } else if (selectedArrowOption === MISS_ARROW_STR) {
          arrowsValue = 0; // Numerical 0 for Miss
          resultTypeValue = NO_RESULT_CODE; // Miss has no standard result type
      } else {
          arrowsValue = parseInt(selectedArrowOption); // Standard 1, 2, 3 as numbers
          resultTypeValue = parseInt(resultSelect.value); // Kill/Wound codes as numbers
          if (isNaN(arrowsValue) || !resultTypeValue) { // Check if valid numbers and result type selected
              alert('Please select valid Arrows and a Result type.');
              return;
          }
      }

      const notes = notesInput.value.trim();

      // Basic validation for target
      if (!target) {
        alert('Please select a Target.');
        return;
      }

      // Update the local 'entries' object for the selected target
      entries[target] = {
        arrows: arrowsValue,
        resultType: resultTypeValue,
        notes: notes
      };
      saveLocal(); // Save updated entries to local storage
      updateTable(); // Refresh the local score table

      // If remote is enabled and Firestore is initialized, update the remote leaderboard
      if (remoteToggle.checked && firestoreInitialized) {
        let name = archerName.value;
        if (!name) {
          alert('Please enter your name to save to remote leaderboard.');
          return;
        }
        name = formatName(name); // Format the name
        archerName.value = name; // Update the input field with formatted name

        // Calculate the total score from current local entries
        const totalScore = Object.values(entries).reduce((sum, entry) => {
          if (entry.resultType === NO_RESULT_CODE && entry.arrows !== 0) { // Custom score
              return sum + entry.arrows; // Custom score is its own value
          }
          // For standard scores, use the scores.js mapping
          return sum + (window.scores?.[entry.resultType]?.[entry.arrows] || 0);
        }, 0);

        // Set the document in the 'leaderboard' collection.
        // Using set() with a specific doc ID (archer name) will create or overwrite it.
        db.collection('leaderboard').doc(name).set({
          name: name,
          totalScore: totalScore,
          date: new Date().toISOString(), // Store date in ISO format for consistent sorting
          entries: entries // Store all entries for detailed view
        }).then(() => {
          console.log("Remote score updated successfully!");
          fetchAllLeaderboardData(); // Re-fetch all data to update month options and display
        }).catch(error => {
          console.error("Error updating remote score:", error);
          alert("Failed to update remote score. Check console for details.");
        });
      }

      // Clear input fields after successful addition/update
      targetSelect.value = '';
      arrowsSelect.value = '';
      resultSelect.value = '';
      notesInput.value = '';
      customScoreInput.value = ''; // Clear custom score input
      // Reset form controls to default state
      resultSelect.disabled = false;
      resultSelectWrapper.classList.remove('is-disabled');
      customScoreInputWrapper.classList.add('hidden');
    });

    // Listen for clicks on the 'Export CSV' button
    exportCSV.addEventListener('click', () => {
      // Determine headers based on mobile view
      const header = ['Target', 'Arrows', 'Result', 'Score'];
      if (!isMobile()) {
        header.push('Notes');
      }

      // Map table rows to CSV format, ensuring content is quoted for safety
      const rows = Array.from(scoreBody.rows).map(row => {
        const cells = Array.from(row.cells);
        let rowData = [
          `"${cells[0].textContent.replace(/"/g, '""')}"`, // Target
          `"${cells[1].textContent.replace(/"/g, '""')}"`, // Arrows
          `"${cells[2].textContent.replace(/"/g, '""')}"`, // Result
          `"${cells[3].textContent.replace(/"/g, '""')}"`  // Score
        ];
        if (!isMobile()) {
          rowData.push(`"${cells[4].textContent.replace(/"/g, '""')}"`); // Notes
        }
        return rowData.join(',');
      });

      const csv = [header.map(h => `"${h}"`).join(','), ...rows].join('\n');

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `3d-archery-scores-${Date.now()}.csv`; // Unique filename
      document.body.appendChild(a); // Append to body to make it clickable
      a.click(); // Programmatically click the link to trigger download
      document.body.removeChild(a); // Clean up the temporary link
      URL.revokeObjectURL(url); // Release the object URL
    });

    // Listen for clicks on the 'Reset All' button
    resetBtn.addEventListener('click', () => {
      showConfirmationModal(); // Show the custom confirmation modal
    });

    // Handle confirmation modal buttons
    confirmResetYes.addEventListener('click', () => {
      hideConfirmationModal();
      localStorage.removeItem('entries'); // Clear local storage entries
      entries = {}; // Clear the 'entries' object in memory
      updateTable(); // Refresh the local score table (which will now be empty)

      // Optionally, if remote is used and an archer name is provided, delete their remote entry
      if (remoteToggle.checked && firestoreInitialized && archerName.value.trim()) {
        const name = formatName(archerName.value); // Format name before deleting
        db.collection('leaderboard').doc(name).delete().then(() => {
          console.log(`Remote score for ${name} deleted.`);
          fetchAllLeaderboardData(); // Re-fetch all data to update month options and display
        }).catch(error => {
          console.error(`Error deleting remote score for ${name}:`, error);
          alert("Failed to delete remote score. Check console for details.");
        });
      }
    });

    confirmResetNo.addEventListener('click', () => {
      hideConfirmationModal(); // Just hide the modal if cancelled
    });

    // Listen for changes on the month selection dropdown
    monthSelect.addEventListener('change', () => {
        displayLeaderboard(monthSelect.value);
    });

    // Listen for clicks on the 'Refresh Leaderboard' button
    refreshLb.addEventListener('click', fetchAllLeaderboardData); // Now refreshes all data and re-filters

    // Listen for clicks on leaderboard table rows to show detailed scores
    document.querySelector('#leaderboardTable tbody')
      .addEventListener('click', async e => {
      const tr = e.target.closest('tr');
      // Ensure a valid row with a name dataset was clicked
      if (!tr || !tr.dataset.name) return;

      const name = tr.dataset.name;
      if (!db) {
        alert("Firestore is not initialized. Cannot fetch detailed scores.");
        return;
      }

      // Check if the clicked row is already followed by a preview-row
      const nextSibling = tr.nextElementSibling;
      const isAlreadyOpen = nextSibling && nextSibling.classList.contains('preview-row');

      // If the clicked row's preview is already open, close it
      if (isAlreadyOpen) {
        nextSibling.remove();
        return;
      }

      // Remove any other existing preview row before opening a new one
      const existingPreview = document.querySelector('.preview-row');
      if (existingPreview) {
        existingPreview.remove();
      }

      try {
        const doc = await db.collection('leaderboard').doc(name).get();
        if (!doc.exists) {
          alert(`No detailed data found for ${name}.`);
          return;
        }

        // Create the new preview row
        const pr = document.createElement('tr');
        pr.classList.add('preview-row', 'slide-enter');

        let html = `<td colspan="3"><table class="table readonly-table">
          <thead><tr><th>#</th><th>Arrows</th><th>Result</th><th>Score</th><th class="hide-on-mobile">Notes</th></tr></thead><tbody>`;

        const data = doc.data();
        // Sort the entries by target number for display
        Object.entries(data.entries || {}).sort((a, b) => parseInt(a[0]) - parseInt(b[0])).forEach(([t, entry]) => {
          let displayArrows = '';
          let displayResult = '';
          let score = 0;

          // Determine display values and score based on stored numerical values
          if (entry.arrows === 0) { // Miss (numerical 0)
              displayArrows = 'Miss';
              displayResult = '';
              score = 0;
          } else if (typeof entry.arrows === 'number' && entry.resultType === NO_RESULT_CODE && entry.arrows !== 0) {
              // This is a custom score
              displayArrows = 'Custom'; // Display 'Custom' in Arrows column
              displayResult = ''; // No result type for custom
              score = entry.arrows; // Custom score is the arrow value itself
          } else if (typeof entry.arrows === 'number' && typeof entry.resultType === 'number') {
              displayArrows = entry.arrows.toString();
              displayResult = RESULT_CODES_MAP[entry.resultType] || '';
              score = window.scores?.[entry.resultType]?.[entry.arrows] || 0;
          } else { // Fallback for old data or malformed entries
              displayArrows = entry.arrows || '';
              displayResult = entry.resultType || '';
              score = 0;
          }

          html += `<tr><td>${t}</td><td>${displayArrows}</td><td>${displayResult}</td><td>${score}</td><td class="hide-on-mobile">${entry.notes || ''}</td></tr>`;
        });

        html += `</tbody><tfoot><tr><th colspan="3">Total</th><th>${data.totalScore}</th><th class="hide-on-mobile"></th></tr></tfoot></table></td>`;
        pr.innerHTML = html;

        // Insert the preview row after the clicked row
        tr.parentNode.insertBefore(pr, tr.nextSibling);

        // Trigger slide-down animation
        requestAnimationFrame(() => pr.classList.add('slide-enter-active'));

      } catch (error) {
        console.error("Error fetching detailed leaderboard entry:", error);
        alert("Failed to load detailed scores. Check console for details.");
      }
    });

    // --- New Event Listener for Local Score Table Rows (Click to Edit) ---
    scoreBody.addEventListener('click', (e) => {
        const clickedRow = e.target.closest('tr');
        if (!clickedRow) return; // Not a row

        // Get the target number from the first cell
        const targetNumber = parseInt(clickedRow.cells[0].textContent);

        // Always set the targetSelect value
        targetSelect.value = targetNumber;

        // Check if there's an existing entry for this target
        if (entries[targetNumber]) {
            const entryData = entries[targetNumber];

            // Handle arrows pre-fill, including 'Custom'
            if (typeof entryData.arrows === 'number' && entryData.resultType === NO_RESULT_CODE && entryData.arrows !== 0) {
                // This is a custom score
                arrowsSelect.value = CUSTOM_ARROW_STR;
                customScoreInput.value = entryData.arrows;
            } else if (entryData.arrows === 0) { // Miss
                arrowsSelect.value = MISS_ARROW_STR;
            } else {
                arrowsSelect.value = entryData.arrows.toString(); // Standard 1, 2, 3
            }

            resultSelect.value = entryData.resultType;
            notesInput.value = entryData.notes;
        } else {
            // If no data for this target, clear other fields
            arrowsSelect.value = '';
            resultSelect.value = '';
            notesInput.value = '';
            customScoreInput.value = ''; // Clear custom score input
        }

        // Ensure the correct result input (select or custom text) is shown/hidden
        handleArrowsSelectChange();

        // Scroll to the score form
        scoreForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });


    // --- Initial Setup on Page Load ---
    initSelects(); // Populate dropdowns
    loadLocal(); // Load saved preferences and apply them
    updateTable(); // Display any existing local scores

    // Initialize the state of resultSelect/customScoreInput based on current arrowsSelect value
    // This handles cases where 'Miss' or 'Custom' might be pre-selected on load (e.g., from local storage)
    handleArrowsSelectChange();

    // Listen for window resize to adjust table columns dynamically
    window.addEventListener('resize', updateTable);
  });
  </script>
</body>
</html>
